// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =================================
// MODÈLE USER
// =================================
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          Role      @default(GUEST)
  isActive      Boolean   @default(true)
  emailVerified Boolean   @default(false)
  
  // Relations
  properties    Property[]
  bookings      Booking[]
  
  // Métadonnées
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?
  
  @@map("users")
}

enum Role {
  GUEST
  OWNER
  ADMIN
}

// =================================
// MODÈLE PROPERTY (Propriété/Établissement)
// =================================
model Property {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  address     String
  city        String
  country     String
  zipCode     String?
  latitude    Float?
  longitude   Float?
  
  // Équipements et caractéristiques
  amenities   Json?    // Liste des équipements (wifi, parking, etc.)
  images      Json?    // URLs des images
  
  // Propriétaire
  ownerId     String
  owner       User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  // Relations
  units       Unit[]
  
  // Métadonnées
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("properties")
  @@index([ownerId])
  @@index([city])
}

// =================================
// MODÈLE UNIT (Unité/Appartement/Chambre)
// =================================
model Unit {
  id            String   @id @default(uuid())
  name          String
  description   String?  @db.Text
  type          UnitType @default(APARTMENT)
  
  // Capacité
  maxGuests     Int      @default(2)
  bedrooms      Int      @default(1)
  beds          Int      @default(1)
  bathrooms     Int      @default(1)
  
  // Surface
  surface       Float?   // en m²
  floor         Int?
  
  // Prix de base
  basePrice     Float
  cleaningFee   Float?   @default(0)
  
  // Équipements spécifiques
  amenities     Json?
  images        Json?
  
  // Relation avec la propriété
  propertyId    String
  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // Relations
  bookings      Booking[]
  calendarFeeds CalendarFeed[]
  availabilities Availability[]
  rates         Rate[]
  
  // Métadonnées
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("units")
  @@index([propertyId])
  @@index([type])
}

enum UnitType {
  APARTMENT
  ROOM
  STUDIO
  HOUSE
  VILLA
}

// =================================
// MODÈLE BOOKING (Réservation)
// =================================
model Booking {
  id            String        @id @default(uuid())
  
  // Informations de réservation
  checkIn       DateTime
  checkOut      DateTime
  numGuests     Int
  
  // Prix
  totalPrice    Float
  cleaningFee   Float         @default(0)
  serviceFee    Float         @default(0)
  
  // Statut
  status        BookingStatus @default(PENDING)
  
  // Notes
  guestNotes    String?       @db.Text
  ownerNotes    String?       @db.Text
  
  // Source de la réservation
  source        BookingSource @default(DIRECT)
  externalId    String?       // ID de réservation externe (Airbnb, Booking.com, etc.)
  
  // Relations
  unitId        String
  unit          Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  guestId       String
  guest         User          @relation(fields: [guestId], references: [id], onDelete: Cascade)
  
  calendarEvents CalendarEvent[]
  
  // Métadonnées
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  cancelledAt   DateTime?
  
  @@map("bookings")
  @@index([unitId])
  @@index([guestId])
  @@index([status])
  @@index([checkIn, checkOut])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum BookingSource {
  DIRECT
  AIRBNB
  BOOKING_COM
  VRBO
  HOMEAWAY
  OTHER
}

// =================================
// MODÈLE CALENDAR_FEED (Flux iCal)
// =================================
model CalendarFeed {
  id          String   @id @default(uuid())
  name        String
  url         String   // URL du flux iCal externe
  source      String   // airbnb, booking.com, vrbo, etc.
  isActive    Boolean  @default(true)
  
  // Relation avec l'unité
  unitId      String
  unit        Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // Synchronisation
  lastSyncAt  DateTime?
  syncStatus  SyncStatus @default(PENDING)
  syncError   String?   @db.Text
  
  // Relations
  events      CalendarEvent[]
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("calendar_feeds")
  @@index([unitId])
  @@index([source])
}

enum SyncStatus {
  PENDING
  SUCCESS
  ERROR
}

// =================================
// MODÈLE CALENDAR_EVENT (Événement de calendrier)
// =================================
model CalendarEvent {
  id          String   @id @default(uuid())
  
  // Informations de l'événement
  summary     String
  description String?  @db.Text
  startDate   DateTime
  endDate     DateTime
  
  // Lien avec la réservation interne (si existe)
  bookingId   String?
  booking     Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  
  // Lien avec le flux iCal source
  feedId      String
  feed        CalendarFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)
  
  // ID externe (UID de l'iCal)
  externalId  String?
  
  // Métadonnées
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("calendar_events")
  @@index([feedId])
  @@index([bookingId])
  @@index([startDate, endDate])
  @@unique([feedId, externalId])
}

// =================================
// MODÈLE AVAILABILITY (Disponibilité)
// =================================
model Availability {
  id        String   @id @default(uuid())
  
  // Période
  startDate DateTime
  endDate   DateTime
  
  // Disponibilité
  isAvailable Boolean @default(true)
  
  // Règles spéciales
  minNights Int?
  maxNights Int?
  
  // Relation avec l'unité
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("availabilities")
  @@index([unitId])
  @@index([startDate, endDate])
}

// =================================
// MODÈLE RATE (Tarification)
// =================================
model Rate {
  id        String   @id @default(uuid())
  
  // Période
  startDate DateTime
  endDate   DateTime
  
  // Prix
  pricePerNight Float
  
  // Type de tarif
  type      RateType @default(STANDARD)
  
  // Description
  name      String?
  
  // Relation avec l'unité
  unitId    String
  unit      Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // Métadonnées
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("rates")
  @@index([unitId])
  @@index([startDate, endDate])
}

enum RateType {
  STANDARD
  WEEKEND
  HOLIDAY
  SEASON_HIGH
  SEASON_LOW
  SPECIAL
}
